# Setting up a Single Node Elasticsearrch Cluster

## Instructions to Setup a Virtualization Platform
The virtual elasticsearch platform can be installed on either Oracle VirtualBox virtualization platform or Microsoft Hyper-V platform

The installation and most of the configuration is fully automated except for setting up the Service Token using a infrastructure as a code platform called Vagrant. Vagrant is a software from HarshiCorp Software foundation. We have to download and install the latest Vagrant software into your desktop. Vagrant is supported on both Windows and Linux. 

Once Vagrant and the Virtualization Hypervisor Platform is ready, we have to just run the below command. 

Microsoft Hyper-V
Start the Windows Command Prompt or PowerShell Terminal or New Windows Terminal in Administrator mode (Elivated Mode)

```dos
vagrant up --provider hyperv
```


Oracle VirtualBox
```dos
vagrant up 
```

Once the installation is done. We have to look at the installation log and get the auto generated password for the elastic user. Keep that copied safely. But anyway we are going to reset that password to a common password for use of use. 

## Setting a Static IP in a Hyper-V Virtual Machine
As of the date, Vagrant is unable to setup a static IP address in the virtual machine. 
Below configuration statements doesn't work. 

```yml
config.vm.network "public_network", bridge "Default Switch", ip "192.168.1.10"
config.vm.network "private_network", ip "192.168.1.10" 
```

Therefore, we have to perform a workaround to get a static ip setup for the virtual machines. 

First we have to comment find the Network Settings for a given Hyper-V virtual switch. The only way to find the network details is by powering on a virtual machine on dhcp mode and then finding the details of the given IP from the network switch. 

To do this we need to log into the virtual machine. 
```dos
vagrant ssh
```

Below command will give us the default network gateway 

```bash
sudo ip route | grep default
```

After that we need to find out the netmask and an example ip. The best way to get that details is by looking at the current DHCP IP settings as below. 

```bash
sudo ip addr
```

Looking at them we can decide a suitable IP address, with netmask and the default gateway to be used in the change-ip-to-static.sh script. 

## Changing the password of the elastic user
The installation autogenerates a password for the builtin admin user - elastic. But since I had to automate most of the configurations in the elasticsearch lab setup, we need to change that autogenerated password into ucsc@1234

```bash
cd scripts/manually-configure
# let's check for the available scripts
ls -al 
# The script we need to run - change-elastic-user-password.sh
# We can run as below
sudo ./change-elastic-user-password.sh
# When prompted to give the password. Enter : ucsc@1234
```
## Instructions to Configure the Service Tokens in Elasticsearch
We need to create a service token to allow kibana to connect to elasticsearch cluster securely. It it not allowed to use the built in elastic user for kibana to log into elasticsearch. 

```bash
cd /usr/share/elasticsearch/bin/
# Run the below command and copy the service token value text file
sudo ./elasticsearch-service-tokens create elastic/kibana kibana_token

# writing the token value to a text file
echo <generated token value> > /home/vagrant/elastice-service-token
```

Save the token to a text file for future use. 

A new file should be created in /etc/elasticsearch directory called service_tokens. 
We need to change the file ownership and permissions for the file

```bash
sudo chown root:elasticsearch /etc/elasticsearch/service_tokens
sudo chmod 660 /etc/elasticsearch/service_tokens 
```

Now we need to add the generated service_token to Kibana KeyStore

```bash
cd /usr/share/kibana/bin
sudo ./kibana-keystore add elasticsearch.serviceAccountToken
```

Now we can start the services. 

```bash
cd /home/vagrant/scripts/manually-configure
sudo ./start-elasticsearch-kibana-service.sh 
```
Both the services should be working properly. The log files for both the services are in the /var/log/elasticsearch/ and /var/log/kibana/ paths respectively. If you have any errors you can look at the error and try to fix the error. 

Get the ip address of the virtual machine with the below command. 

```bash
sudo ip addr
```

Then in your windows browser type the url as below. 

https://<ip address>:5601

We should get a warning from the browser, but we can click continue / proceed. That should lead us to the kibana page. The user name is elastic and the password is the auto generated password. 

> NOTE: 
>
>    If the Kibana Service doesn't come up and no log is written to the /var/log/kibana/kibana.log file. 
>    
>   ```bash
>    sudo journalctl -u kibana.service -n 75
>   ```
>
>   Then we have to un-comment one option at the node.options file. 
>
>   The below line needs to be commented
>
>    --unhandled-rejections=warn 
>
>   After that we can start the services
>
>   ```bash
>   sudo systemctl restart kibana.service
>   sudo systemctl status kibana.service
>   ```

### Setting up Metricbeat in Elasticsearch Server/
For this simple lab, I have automatically added configured metricbeat configuration files as well as the configuration files for the metricbeat modules automatically. The metricbeat will use the user - elastic to loginto elasticsearch and stream data. 

Let's configure the metricbeat now. 

```bash
cd /home/vagrant/scripts/manually-configure
## initializing metricbeat will test the config files, test the connection with elasticsearch and upload sample dashboards into kibana
sudo  ./initialize-beats-metricbeat.sh
```
### Setting up Packetbeat in Elasticsearch Server/
For this simple lab, I have automatically added configured packetbeat configuration files as well as the configuration files for the packetbeat modules automatically. The packetbeat will use the user - elastic to loginto elasticsearch and stream data. 

Let's configure the packetbeat now. 

```bash
cd /home/vagrant/scripts/manually-configure
## initializing packetbeat will test the config files, test the connection with elasticsearch and upload sample dashboards into kibana
sudo  ./initialize-beats-packetbeat.sh
```
### Setting up Filebeat in Elasticsearch Server/
For this simple lab, I have automatically added configured filebeat configuration files as well as the configuration files for the filebeat modules automatically. The filebeat will use the user - elastic to loginto elasticsearch and stream data. 

Let's configure the metricbeat now. 

```bash
cd /home/vagrant/scripts/manually-configure
## initializing filebeat will test the config files, test the connection with elasticsearch and upload sample dashboards into kibana
sudo  ./initialize-beats-filebeat.sh
```

### Setting up Auditbeat in Elasticsearch Server/
For this simple lab, I have automatically added configured auditbeat configuration files as well as the configuration files for the auditbeat modules automatically. The auditbeat will use the user - elastic to loginto elasticsearch and stream data. 

Let's configure the auditbeat now. 

```bash
cd /home/vagrant/scripts/manually-configure
## initializing auditbeat will test the config files, test the connection with elasticsearch and upload sample dashboards into kibana
sudo  ./initialize-beats-auditbeat.sh
```




